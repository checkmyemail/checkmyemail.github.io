<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check if my email service is working</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- hCaptcha script -->
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 400px;
            position: relative;
        }
        /* Style for the question mark button inside the message box */
        #messageBox .question-mark-button {
            position: absolute;
            top: 0.75rem; /* Adjust as needed */
            right: 0.75rem; /* Adjust as needed */
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: inherit; /* Inherit color from parent message box */
            opacity: 0.7;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            font-size: 1.25rem;
            font-weight: bold;
            line-height: 1;
        }
        #messageBox .question-mark-button:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        /* New styles for the unlimited tests notification banner */
        #unlimitedTestsBanner, #usbCounterBanner { 
            position: fixed;
            right: 20px;
            width: 90%;
            max-width: 320px; 
            background: linear-gradient(to right, #4F46E5, #8B5CF6); 
            color: white;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            z-index: 900; 
            transform: translateX(120%); 
            transition: transform 0.5s ease-out; 
        }
        #unlimitedTestsBanner.show, #usbCounterBanner.show {
            transform: translateX(0); 
        }
        #unlimitedTestsBanner .dismiss-button, #usbCounterBanner .dismiss-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        #unlimitedTestsBanner .dismiss-button:hover, #usbCounterBanner .dismiss-button:hover {
            opacity: 1;
        }
        #unlimitedTestsBanner {
            top: 20px; /* Position the first banner */
        }
        #usbCounterBanner { 
            background: linear-gradient(to right, #2563EB, #3B82F6); 
            top: 200px; /* Position below the first banner with more space */
        }

        /* Spinner animation for USB modal */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 pb-20">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md mb-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Test Your Email Reception</h1>

        <p class="text-gray-600 text-sm mb-6 text-center">
            Enter an email address below to verify that you are properly receiving emails.
        </p>

        <form id="webhookForm" class="space-y-4">
            <div>
                <label for="emailInput" class="block text-gray-700 text-sm font-medium mb-2">Email to Test:</label>
                <div class="relative">
                    <input
                        type="email"
                        id="emailInput"
                        placeholder="your-email@example.com"
                        required
                        class="w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                    >
                    <button type="button" id="microphoneButton" class="absolute inset-y-0 right-0 flex items-center pr-3 focus:outline-none">
                        <!-- Microphone Icon (Inline SVG for simplicity) -->
                        <svg class="h-6 w-6 text-gray-500 hover:text-gray-700 transition-colors duration-200" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.2-3c0 3.53-2.93 6.43-6.4 6.43S4.4 14.53 4.4 11H3c0 3.98 3.44 7.27 7.8 7.74V22h2.4v-3.27c4.36-.47 7.8-3.76 7.8-7.74h-1.4z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <button
                type="submit"
                id="sendButton"
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md flex items-center justify-center"
            >
                <span id="buttonText">Send Test Email</span>
            </button>
        </form>

        <div id="messageBox" class="mt-6 p-4 rounded-lg hidden relative">
            <p id="messageText" class="font-medium"></p>
            <button id="messageErrorInfoButton" class="question-mark-button hidden">
                ðŸ¤”
            </button>
        </div>

        <div class="mt-6 pt-4 border-t border-gray-200 text-center">
            <button id="checkStatusButton" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200 mr-2">
                Check Status
            </button>
            <button id="viewInfoButton" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">
                Enable Developer Mode
            </button>
        </div>

    </div>

    <!-- Unlimited Tests Notification Banner -->
    <div id="unlimitedTestsBanner" class="hidden">
        <button class="dismiss-button" id="dismissUnlimitedTestsBanner">
            &times;
        </button>
        <h2 class="text-xl font-bold mb-2">Get Unlimited Tests and remove ads!</h2>
        <p class="text-sm mb-4">
            Complete the hCaptcha challenge to get unlimited test emails and remove ads for one hour!
        </p>
        <button id="getUnlimitedTestsButton" class="w-full px-4 py-2 bg-white text-purple-600 rounded-lg font-semibold hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 transition duration-200 shadow-md">
            Complete Challenge
        </button>
    </div>

    <!-- USB Counter Advertisement Banner -->
    <div id="usbCounterBanner" class="hidden">
        <button class="dismiss-button" id="dismissUsbCounterBanner">
            &times;
        </button>
        <small class="text-xs font-semibold uppercase opacity-75 mb-1">Advertisement</small>
        <h2 class="text-xl font-bold mb-2">Count My USBs!</h2>
        <p class="text-sm mb-4">
            Count how many USBs are connected to your computer!
        </p>
        <button id="scanNowButton" class="w-full px-4 py-2 bg-white text-blue-600 rounded-lg font-semibold hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 transition duration-200 shadow-md">
            Scan Now
        </button>
    </div>

    <div id="businessEmailBanner" class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 flex flex-col sm:flex-row items-center justify-center sm:justify-between space-y-3 sm:space-y-0 sm:space-x-4 shadow-xl rounded-t-lg z-50 opacity-100 transition-opacity duration-500 ease-out">
        <p class="text-base font-semibold text-center sm:text-left">
            Uncover crucial website details and insights instantly, all without visiting it!
        </p>
        <div class="flex items-center space-x-3">
            <button id="getBusinessEmailButton" class="bg-white text-blue-700 px-5 py-2 rounded-full font-bold text-sm shadow-md hover:bg-gray-100 transition duration-200">
                Learn More
            </button>
            <button id="dismissBannerButton" class="text-white hover:text-gray-200 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <div id="limitInfoModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeLimitInfoModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Daily Email Limit Explained</h2>
            
            <div id="modalCountdownContainer" class="text-center mb-4 flex flex-col items-center justify-center">
                <p class="text-lg text-gray-700">Next test available in:</p>
                <div id="modalCountdownDisplay" class="text-5xl font-extrabold text-blue-600 mt-2">
                    --h --m --s
                </div>
            </div>

            <div class="mt-4 p-3 bg-gray-100 rounded-lg text-sm text-gray-700">
                <p>To ensure fair usage and manage resources, this service allows only one test email per user per day.</p>
                <p class="mt-2">This daily limit resets at <strong>0:00 UTC (Coordinated Universal Time)</strong>, which is midnight UTC. The countdown shown above indicates when you can send your next test email in your local time.</p>
                <p class="mt-2">This helps prevent abuse and keeps the service available for everyone.</p>
            </div>
        </div>
    </div>

    <!-- hCaptcha Modal -->
    <div id="hCaptchaModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeHCaptchaModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Verify You're Not a Robot</h2>
            <div class="flex justify-center my-6">
                <div class="h-captcha" data-sitekey="ee3c369e-9fb4-424c-8ad6-10c414fa6dac" data-callback="onHCaptchaSuccess" data-error-callback="onHCaptchaError"></div>
            </div>
            <div id="hCaptchaMessage" class="mt-4 p-3 rounded-lg hidden text-sm font-medium text-center"></div>
        </div>
    </div>

    <!-- Video Overlay for Success Animation -->
    <div id="successVideoOverlay" class="modal-overlay hidden z-[1100]">
        <video id="successVideo" class="max-w-full max-h-full rounded-lg shadow-xl" autoplay muted playsinline>
            Your browser does not support the video tag.
        </video>
    </div>

    <!-- Status Display Modal -->
    <div id="statusModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeStatusModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Current Test Status</h2>
            <div id="statusModalContent" class="p-4 rounded-lg border text-center">
                <!-- Status content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Custom Voice Confirmation Modal -->
    <div id="voiceConfirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeVoiceConfirmationModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Voice Input Confirmation</h2>
            <p class="text-gray-700 text-base mb-4 text-center">
                Your voice will be sent to third-parties for dictation! Are you sure you want to continue?
            </p>
            <div class="flex justify-around mt-6 space-x-4">
                <button id="voiceConfirmButton" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                    Yes
                </button>
                <button id="voiceCancelButton" class="w-1/2 bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-200">
                    No
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Consent Modal -->
    <div id="notificationConsentModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeNotificationConsentModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Allow Notifications?</h2>
            <p class="text-gray-700 text-base mb-4 text-center">
                Allow notifications so you can be updated when the 1 hour limit runs out.
            </p>
            <div class="flex justify-around mt-6 space-x-4">
                <button id="allowNotificationsButton" class="w-1/2 bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-200">
                    Allow Notifications
                </button>
                <button id="dismissNotificationsButton" class="w-1/2 bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-200">
                    Dismiss
                </button>
            </div>
        </div>
    </div>

    <!-- USB Scan Modal -->
    <div id="usbScanModal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <button id="closeUsbScanModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4" id="usbScanModalTitle">Counting USBs...</h2>
            <div id="usbScanModalContent" class="flex flex-col items-center justify-center p-4">
                <div class="spinner" id="usbSpinner"></div>
                <p class="text-gray-700 mt-4" id="usbScanMessage">Attempting to detect connected USB devices.</p>
            </div>
        </div>
    </div>


    <script>
        const webhookForm = document.getElementById('webhookForm');
        const emailInput = document.getElementById('emailInput');
        const sendButton = document.getElementById('sendButton');
        const buttonText = document.getElementById('buttonText');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageErrorInfoButton = document.getElementById('messageErrorInfoButton');
        const microphoneButton = document.getElementById('microphoneButton');

        const viewInfoButton = document.getElementById('viewInfoButton');
        const checkStatusButton = document.getElementById('checkStatusButton');
        
        const businessEmailBanner = document.getElementById('businessEmailBanner');
        const getBusinessEmailButton = document.getElementById('getBusinessEmailButton');
        const dismissBannerButton = document.getElementById('dismissBannerButton');

        const limitInfoModal = document.getElementById('limitInfoModal');
        const closeLimitInfoModal = document.getElementById('closeLimitInfoModal');
        const modalCountdownContainer = document.getElementById('modalCountdownContainer');
        const modalCountdownDisplay = document.getElementById('modalCountdownDisplay');

        const unlimitedTestsBanner = document.getElementById('unlimitedTestsBanner');
        const dismissUnlimitedTestsBanner = document.getElementById('dismissUnlimitedTestsBanner');
        const getUnlimitedTestsButton = document.getElementById('getUnlimitedTestsButton');

        const usbCounterBanner = document.getElementById('usbCounterBanner');
        const dismissUsbCounterBanner = document.getElementById('dismissUsbCounterBanner');
        const scanNowButton = document.getElementById('scanNowButton');


        const hCaptchaModal = document.getElementById('hCaptchaModal');
        const closeHCaptchaModal = document.getElementById('closeHCaptchaModal');
        const hCaptchaMessage = document.getElementById('hCaptchaMessage');

        const successVideoOverlay = document.getElementById('successVideoOverlay');
        const successVideo = document.getElementById('successVideo');

        const statusModal = document.getElementById('statusModal');
        const closeStatusModal = document.getElementById('closeStatusModal');
        const statusModalContent = document.getElementById('statusModalContent');

        const voiceConfirmationModal = document.getElementById('voiceConfirmationModal');
        const closeVoiceConfirmationModal = document.getElementById('closeVoiceConfirmationModal');
        const voiceConfirmButton = document.getElementById('voiceConfirmButton');
        const voiceCancelButton = document.getElementById('voiceCancelButton');

        const notificationConsentModal = document.getElementById('notificationConsentModal');
        const closeNotificationConsentModal = document.getElementById('closeNotificationConsentModal');
        const allowNotificationsButton = document.getElementById('allowNotificationsButton');
        const dismissNotificationsButton = document.getElementById('dismissNotificationsButton');

        // USB Scan Modal elements
        const usbScanModal = document.getElementById('usbScanModal');
        const closeUsbScanModal = document.getElementById('closeUsbScanModal');
        const usbScanModalTitle = document.getElementById('usbScanModalTitle');
        const usbScanModalContent = document.getElementById('usbScanModalContent');
        const usbSpinner = document.getElementById('usbSpinner');
        const usbScanMessage = document.getElementById('usbScanMessage');


        const DEFAULT_WEBHOOK_URL = 'https://eo4grj5d1bhbj6f.m.pipedream.net';
        const SRC_PARAM_WEBHOOK_URL = 'https://eor9n5ln3tor0v8.m.pipedream.net';
        const SRC_PARAM_VALUE = 'https://webinfofinder.github.io/';
        const LAST_SENT_KEY = 'lastEmailSentDateUTC';
        const UNLIMITED_ACCESS_EXPIRY_KEY = 'unlimitedAccessExpiry';
        const NOTIFICATION_PERMISSION_KEY = 'notificationPermission'; 

        let countdownInterval;
        let isUnlimitedTestsActive = false;
        let isDeveloperModeChallengeActive = false;
        let statusCountdownInterval; 
        let expiryNotificationTimeout;


        let recognition;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; 
            recognition.interimResults = false; 
            recognition.lang = 'en-US'; 
        } else {
            console.warn('Web Speech API is not supported in this browser.');
            microphoneButton.disabled = true; 
            microphoneButton.title = 'Voice input not supported in this browser.';
        }

        recognition.onstart = function() {
            showMessage('Listening for your voice...', 'info');
            emailInput.placeholder = 'Speak now...';
        };

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            emailInput.value = transcript.replace(/\s/g, ''); 
            showMessage(`Dictated: "${transcript}". Removed spaces for email format.`, 'success');
            emailInput.placeholder = 'your-email@example.com';
        };

        recognition.onend = function() {
            console.log('Speech recognition ended.');
            if (emailInput.value === '' || !emailInput.value.includes('@')) { 
                 showMessage('No valid email speech detected or recognition stopped. Please try again.', 'error');
            }
        };

        recognition.onerror = function(event) {
            let errorMessage = 'Speech recognition error: ' + event.error;
            if (event.error === 'no-speech') {
                errorMessage = 'No speech detected. Please try again.';
            } else if (event.error === 'not-allowed') {
                errorMessage = 'Microphone access denied. Please allow microphone in browser settings.';
            } else if (event.error === 'aborted') {
                errorMessage = 'Speech recognition aborted.';
            }
            showMessage(errorMessage, 'error');
            emailInput.placeholder = 'your-email@example.com';
        };

        // --- Notification Functions ---
        function showNotificationConsentModal() {
            notificationConsentModal.classList.remove('hidden');
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showMessage("Notifications are not supported in this browser.", "error");
                localStorage.setItem(NOTIFICATION_PERMISSION_KEY, 'unsupported');
                notificationConsentModal.classList.add('hidden');
                return;
            }

            Notification.requestPermission().then(permission => {
                localStorage.setItem(NOTIFICATION_PERMISSION_KEY, permission);
                if (permission === 'granted') {
                    sendTestNotification("Notifications Allowed!", "You'll now receive updates about your unlimited test access.");
                    scheduleExpiryNotification(); 
                    showMessage("Notifications allowed. A test notification was sent.", "success");
                } else if (permission === 'denied') {
                    showMessage("Notification permission denied. You will not receive expiry alerts.", "error");
                } else { 
                    showMessage("Notification permission blocked or dismissed.", "info");
                }
                notificationConsentModal.classList.add('hidden');
            });
        }

        function sendTestNotification(title, body) {
            if (Notification.permission === 'granted') {
                new Notification(title, { body: body });
            }
        }

        function scheduleExpiryNotification() {
            if (expiryNotificationTimeout) {
                clearTimeout(expiryNotificationTimeout);
            }

            const expiryTimeStr = localStorage.getItem(UNLIMITED_ACCESS_EXPIRY_KEY);
            if (expiryTimeStr && Notification.permission === 'granted') {
                const expiryTime = parseInt(expiryTimeStr, 10);
                const now = Date.now();
                const fiveMinutesBeforeExpiry = expiryTime - (5 * 60 * 1000); 

                if (fiveMinutesBeforeExpiry > now) {
                    const timeUntilNotification = fiveMinutesBeforeExpiry - now;
                    expiryNotificationTimeout = setTimeout(() => {
                        new Notification("Unlimited Tests Expiring Soon!", {
                            body: "Your 1-hour unlimited email test access will expire in 5 minutes. Complete the challenge again to renew!"
                        });
                        expiryNotificationTimeout = null; 
                    }, timeUntilNotification);
                    console.log(`Scheduled expiry notification for ${new Date(fiveMinutesBeforeExpiry).toLocaleString()}`);
                } else if (expiryTime > now) {
                    new Notification("Unlimited Tests Expiring Soon!", {
                        body: "Your 1-hour unlimited test email access will expire very soon!"
                    });
                }
            }
        }
        // --- End Notification Functions ---


        window.onHCaptchaSuccess = function(token) {
            console.log('hCaptcha success! Token:', token);
            hCaptchaMessage.classList.add('hidden');

            if (isDeveloperModeChallengeActive) {
                isDeveloperModeChallengeActive = false;
                hCaptchaModal.classList.add('hidden');
                window.location.href = 'dev.html';
            } else {
                isUnlimitedTestsActive = true; 
                hCaptchaMessage.textContent = 'Verification successful! You now have unlimited tests for 1 hour.';
                hCaptchaMessage.classList.remove('hidden', 'bg-red-100', 'text-red-800');
                hCaptchaMessage.classList.add('bg-green-100', 'text-green-800');
                
                unlimitedTestsBanner.classList.remove('show');
                unlimitedTestsBanner.classList.add('hidden');
                usbCounterBanner.classList.remove('show'); 
                usbCounterBanner.classList.add('hidden');
                
                localStorage.removeItem(LAST_SENT_KEY);

                const expiryTime = Date.now() + (60 * 60 * 1000); 
                localStorage.setItem(UNLIMITED_ACCESS_EXPIRY_KEY, expiryTime.toString());

                successVideoOverlay.classList.remove('hidden');
                successVideo.src = 'complete.webm';
                successVideo.play().catch(error => {
                    console.error("Video playback failed:", error);
                    successVideoOverlay.classList.add('hidden');
                    successVideo.src = '';
                });

                successVideo.onended = () => {
                    successVideoOverlay.classList.add('hidden');
                    successVideo.src = '';
                    checkAndManageUnlimitedAccess(); 
                    showNotificationConsentModal(); 
                };

                setTimeout(() => {
                    hCaptchaMessage.classList.add('hidden');
                }, 2000); 

                checkStatusAndDisplay(); 
            }
        };

        window.onHCaptchaError = function(error) {
            console.error('hCaptcha error:', error);
            isUnlimitedTestsActive = false; 
            isDeveloperModeChallengeActive = false; 

            hCaptchaMessage.textContent = 'Verification failed. Please try again.';
            hCaptchaMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800');
            hCaptchaMessage.classList.add('bg-red-100', 'text-red-800');
        };

        function checkAndManageUnlimitedAccess() {
            const expiryTimeStr = localStorage.getItem(UNLIMITED_ACCESS_EXPIRY_KEY);
            if (expiryTimeStr) {
                const expiryTime = parseInt(expiryTimeStr, 10);
                if (Date.now() < expiryTime) {
                    isUnlimitedTestsActive = true;
                    unlimitedTestsBanner.classList.remove('show');
                    unlimitedTestsBanner.classList.add('hidden');
                    usbCounterBanner.classList.remove('show'); 
                    usbCounterBanner.classList.add('hidden');
                    if (localStorage.getItem(NOTIFICATION_PERMISSION_KEY) === 'granted') {
                        scheduleExpiryNotification();
                    }
                } else {
                    isUnlimitedTestsActive = false;
                    localStorage.removeItem(UNLIMITED_ACCESS_EXPIRY_KEY);
                    unlimitedTestsBanner.classList.remove('hidden');
                    setTimeout(() => unlimitedTestsBanner.classList.add('show'), 50);

                    usbCounterBanner.classList.add('hidden');
                    setTimeout(() => {
                        usbCounterBanner.classList.remove('hidden');
                        setTimeout(() => usbCounterBanner.classList.add('show'), 50);
                    }, 5000);
                }
            } else {
                isUnlimitedTestsActive = false;
                unlimitedTestsBanner.classList.remove('hidden');
                setTimeout(() => unlimitedTestsBanner.classList.add('show'), 50);

                usbCounterBanner.classList.add('hidden');
                setTimeout(() => {
                    usbCounterBanner.classList.remove('hidden');
                    setTimeout(() => usbCounterBanner.classList.add('show'), 50);
                }, 5000);
            }
        }

        function hasSentEmailTodayUTC() {
            if (isUnlimitedTestsActive) {
                return false;
            }

            const lastSentDateString = localStorage.getItem(LAST_SENT_KEY);
            if (!lastSentDateString) {
                return false;
            }
            const lastSentDate = new Date(lastSentDateString);
            const today = new Date();

            return (
                lastSentDate.getUTCFullYear() === today.getUTCFullYear() &&
                lastSentDate.getUTCMonth() === today.getUTCMonth() &&
                lastSentDate.getUTCDate() === today.getUTCDate()
            );
        }

        function updateLastSentDateUTC() {
            localStorage.setItem(LAST_SENT_KEY, new Date().toISOString());
        }

        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(hours)}h ${pad(minutes)}m ${pad(seconds)}s`;
        }

        function startCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            const now = new Date();
            const nextDayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1, 0, 0, 0, 0));
            
            const options = { hour: 'numeric', minute: 'numeric', hour12: true, timeZoneName: 'short' };
            const localResetTime = nextDayUTC.toLocaleTimeString(undefined, options);

            const updateCountdown = () => {
                const remainingTime = nextDayUTC.getTime() - new Date().getTime();
                const formattedTime = formatTime(remainingTime);

                if (remainingTime <= 0) {
                    clearInterval(countdownInterval);
                    showMessage('You can now send another test email. Please try again!', 'info');
                    setButtonState(false);
                    messageErrorInfoButton.classList.add('hidden');
                    if (modalCountdownContainer) {
                        modalCountdownContainer.classList.add('hidden');
                    }
                    checkAndManageUnlimitedAccess(); 
                    return;
                }

                messageText.innerHTML = `You can only send one test email per UTC day. The limit resets at <strong>${localResetTime}</strong>. Next test in: <span class="font-bold">${formattedTime}</span>`;
                messageErrorInfoButton.classList.remove('hidden');

                if (modalCountdownDisplay && !limitInfoModal.classList.contains('hidden')) {
                    modalCountdownDisplay.textContent = formattedTime;
                    modalCountdownContainer.classList.remove('hidden');
                }
            };

            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function checkStatusAndDisplay() {
            statusModal.classList.remove('hidden');
            
            if (statusCountdownInterval) {
                clearInterval(statusCountdownInterval);
                statusCountdownInterval = null;
            }

            statusModalContent.innerHTML = '';
            statusModalContent.classList.remove('bg-red-100', 'border-red-200', 'text-red-800', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-blue-100', 'border-blue-200', 'text-blue-800');
            statusModalContent.classList.add('p-4', 'rounded-lg', 'border');

            const expiryTimeStr = localStorage.getItem(UNLIMITED_ACCESS_EXPIRY_KEY);
            const expiryTime = expiryTimeStr ? parseInt(expiryTimeStr, 10) : 0;
            const now = Date.now();

            if (isUnlimitedTestsActive && now < expiryTime) {
                statusModalContent.classList.add('bg-blue-100', 'border-blue-200', 'text-blue-800');
                
                const updateUnlimitedCountdown = () => {
                    let remainingMillis = expiryTime - Date.now();
                    if (remainingMillis <= 0) {
                        clearInterval(statusCountdownInterval);
                        isUnlimitedTestsActive = false;
                        localStorage.removeItem(UNLIMITED_ACCESS_EXPIRY_KEY);
                        checkAndManageUnlimitedAccess();
                        checkStatusAndDisplay(); 
                        return;
                    }
                    let formattedTime = formatTime(remainingMillis);
                    statusModalContent.innerHTML = `
                        <p class="font-medium text-center">You have unlimited tests for: <span class="font-bold">${formattedTime}</span></p>
                        <button id="endUnlimitedButton" class="mt-4 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-200">
                            End Now
                        </button>
                    `;
                    const endUnlimitedButton = document.getElementById('endUnlimitedButton');
                    if (endUnlimitedButton) {
                        endUnlimitedButton.onclick = function() {
                            isUnlimitedTestsActive = false;
                            localStorage.removeItem(UNLIMITED_ACCESS_EXPIRY_KEY);
                            if (expiryNotificationTimeout) {
                                clearTimeout(expiryNotificationTimeout);
                                expiryNotificationTimeout = null;
                            }
                            checkAndManageUnlimitedAccess(); 
                            checkStatusAndDisplay(); 
                        };
                    }
                };
                updateUnlimitedCountdown();
                statusCountdownInterval = setInterval(updateUnlimitedCountdown, 1000);

            } else {
                isUnlimitedTestsActive = false;
                localStorage.removeItem(UNLIMITED_ACCESS_EXPIRY_KEY);

                if (hasSentEmailTodayUTC()) {
                    statusModalContent.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                    
                    const updateDailyCountdown = () => {
                        const nextDayUTC = new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate() + 1, 0, 0, 0, 0));
                        let remainingTime = nextDayUTC.getTime() - Date.now();
                        let formattedTime = formatTime(remainingTime);
                        const options = { hour: 'numeric', minute: 'numeric', hour12: true, timeZoneName: 'short' };
                        const localResetTime = nextDayUTC.toLocaleTimeString(undefined, options);

                        if (remainingTime <= 0) {
                            clearInterval(statusCountdownInterval);
                            checkStatusAndDisplay(); 
                            return;
                        }

                        statusModalContent.innerHTML = `
                            <p class="font-medium text-center">You have no tests left for today.</p>
                            <p class="text-sm text-center mt-2">Next test available at ${localResetTime}. Remaining: <span class="font-bold">${formattedTime}</span></p>
                            <div class="mt-4 p-4 rounded-lg bg-white shadow-sm flex flex-col items-center">
                                <p class="font-semibold text-gray-800 mb-3">Get Unlimited Tests!</p>
                                <button id="statusGetUnlimitedButton" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                                    Complete Challenge
                                </button>
                            </div>
                        `;
                        const statusGetUnlimitedButton = document.getElementById('statusGetUnlimitedButton');
                        if (statusGetUnlimitedButton) {
                            statusGetUnlimitedButton.onclick = function() {
                                isDeveloperModeChallengeActive = false; 
                                hCaptchaModal.classList.remove('hidden');
                                hCaptchaMessage.classList.add('hidden');
                                hcaptcha.reset();
                                statusModal.classList.add('hidden'); 
                            };
                        }
                    };
                    updateDailyCountdown();
                    statusCountdownInterval = setInterval(updateDailyCountdown, 1000);

                    unlimitedTestsBanner.classList.remove('hidden');
                    setTimeout(() => unlimitedTestsBanner.classList.add('show'), 50);
                    usbCounterBanner.classList.add('hidden'); 
                    setTimeout(() => {
                        usbCounterBanner.classList.remove('hidden');
                        setTimeout(() => usbCounterBanner.classList.add('show'), 50);
                    }, 5000);

                } else {
                    statusModalContent.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                    statusModalContent.innerHTML = `
                        <p class="font-medium text-center">You have 1 test left for today.</p>
                        <div class="mt-4 p-4 rounded-lg bg-white shadow-sm flex flex-col items-center">
                            <p class="font-semibold text-gray-800 mb-3">Get Unlimited Tests!</p>
                            <button id="statusGetUnlimitedButton" class="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200">
                                Complete Challenge
                            </button>
                        </div>
                    `;
                    const statusGetUnlimitedButton = document.getElementById('statusGetUnlimitedButton');
                    if (statusGetUnlimitedButton) {
                        statusGetUnlimitedButton.addEventListener('click', function() {
                            isDeveloperModeChallengeActive = false; 
                            hCaptchaModal.classList.remove('hidden');
                            hCaptchaMessage.classList.add('hidden');
                            hcaptcha.reset();
                            statusModal.classList.add('hidden'); 
                        });
                    }
                    unlimitedTestsBanner.classList.remove('hidden');
                    setTimeout(() => unlimitedTestsBanner.classList.add('show'), 50);
                    usbCounterBanner.classList.add('hidden'); 
                    setTimeout(() => {
                        usbCounterBanner.classList.remove('hidden');
                        setTimeout(() => usbCounterBanner.classList.add('show'), 50);
                    }, 5000);
                }
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            checkAndManageUnlimitedAccess();

            const urlParams = new URLSearchParams(window.location.search);

            console.log('URL Parameter: hidebanner =', urlParams.get('hidebanner'));
            console.log('URL Parameter: src =', urlParams.get('src'));


            if (urlParams.get('hidebanner') === 'true') {
                businessEmailBanner.classList.add('hidden');
            }

            if (urlParams.get('src') === SRC_PARAM_VALUE) {
                fetch(SRC_PARAM_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        source: SRC_PARAM_VALUE,
                        triggered_on_load: true
                    })
                }).then(response => {
                    if (!response.ok) {
                        console.error('Automatic webhook call failed:', response.status);
                    }
                }).catch(error => {
                    console.error('Error during automatic webhook call:', error);
                });
            }
        });

        function showMessage(message, type = 'info') {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            messageText.innerHTML = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-blue-100', 'border-blue-200', 'text-blue-800');

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                messageErrorInfoButton.classList.add('hidden');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                if (message.includes('You can only send one test email per UTC day')) {
                     messageErrorInfoButton.classList.remove('hidden');
                } else {
                     messageErrorInfoButton.classList.add('hidden');
                }
            } else {
                messageBox.classList.add('bg-blue-100', 'border-blue-200', 'text-blue-800');
                messageErrorInfoButton.classList.add('hidden');
            }
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            messageErrorInfoButton.classList.add('hidden');
            if (modalCountdownContainer) {
                modalCountdownContainer.classList.add('hidden');
            }
        }

        function setButtonState(isLoading) {
            sendButton.disabled = isLoading;
            buttonText.textContent = isLoading ? 'Sending...' : 'Send Test Email';
        }

        webhookForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            hideMessage();
            setButtonState(true);

            checkAndManageUnlimitedAccess(); 

            if (!isUnlimitedTestsActive && hasSentEmailTodayUTC()) {
                showMessage('You can only send one test email per UTC day. Calculating next availability...', 'error');
                startCountdown();
                setButtonState(false);
                return;
            }

            const recipientEmail = emailInput.value;

            try {
                const response = await fetch(DEFAULT_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: recipientEmail
                    })
                });

                if (response.ok) {
                    if (!isUnlimitedTestsActive) {
                        updateLastSentDateUTC();
                    }
                    showMessage(`Test email successfully sent to: <span class="font-bold">${recipientEmail}</span>. Please check your inbox.`, 'success');
                } else {
                    const errorText = await response.text();
                    showMessage(`Failed to send test email. Status: ${response.status}. ${errorText ? `Details: ${errorText}` : 'Please check your Pipedream account for logs and quota status.'}`, 'error');
                }
            } catch (error) {
                showMessage(`An error occurred: ${error.message}. Please check the URL and your network connection.`, 'error');
            } finally {
                setButtonState(false);
            }
        });

        checkStatusButton.addEventListener('click', checkStatusAndDisplay);

        viewInfoButton.addEventListener('click', function() {
            isDeveloperModeChallengeActive = true; 
            hCaptchaModal.classList.remove('hidden');
            hCaptchaMessage.classList.add('hidden');
            hcaptcha.reset(); 
        });

        dismissBannerButton.addEventListener('click', function() {
            businessEmailBanner.classList.remove('opacity-100');
            businessEmailBanner.classList.add('opacity-0');
            setTimeout(() => {
                businessEmailBanner.classList.add('hidden');
            }, 500);
        });

        getBusinessEmailButton.addEventListener('click', function() {
            window.location.href = 'https://webinfofinder.github.io/';
        });

        messageErrorInfoButton.addEventListener('click', function() {
            limitInfoModal.classList.remove('hidden');
            startCountdown(); 
            if (modalCountdownContainer) {
                modalCountdownContainer.classList.add('hidden');
            }
        });

        closeLimitInfoModal.addEventListener('click', function() {
            limitInfoModal.classList.add('hidden');
            if (modalCountdownContainer) {
                modalCountdownContainer.classList.add('hidden');
            }
        });

        limitInfoModal.addEventListener('click', function(event) {
            if (event.target === limitInfoModal) {
                limitInfoModal.classList.add('hidden');
                if (modalCountdownContainer) {
                    modalCountdownContainer.classList.add('hidden');
                }
            }
        });

        dismissUnlimitedTestsBanner.addEventListener('click', function() {
            unlimitedTestsBanner.classList.remove('show');
            unlimitedTestsBanner.classList.add('hidden');
        });

        getUnlimitedTestsButton.addEventListener('click', function() {
            isDeveloperModeChallengeActive = false; 
            hCaptchaModal.classList.remove('hidden');
            hCaptchaMessage.classList.add('hidden');
            hcaptcha.reset();
        });

        closeHCaptchaModal.addEventListener('click', function() {
            hCaptchaModal.classList.add('hidden');
            hcaptcha.reset();
            if (isDeveloperModeChallengeActive) { 
                isDeveloperModeChallengeActive = false;
            }
        });

        hCaptchaModal.addEventListener('click', function(event) {
            if (event.target === hCaptchaModal) {
                hCaptchaModal.classList.add('hidden');
                hcaptcha.reset();
                if (isDeveloperModeChallengeActive) { 
                    isDeveloperModeChallengeActive = false;
                }
            }
        });

        closeStatusModal.addEventListener('click', function() {
            statusModal.classList.add('hidden');
            if (statusCountdownInterval) {
                clearInterval(statusCountdownInterval);
                statusCountdownInterval = null;
            }
        });

        statusModal.addEventListener('click', function(event) {
            if (event.target === statusModal) {
                statusModal.classList.add('hidden');
                if (statusCountdownInterval) {
                    clearInterval(statusCountdownInterval);
                    statusCountdownInterval = null;
                }
            }
        });

        microphoneButton.addEventListener('click', function() {
            if (!recognition) {
                showMessage("Voice input is not supported in this browser.", "error");
                return;
            }
            voiceConfirmationModal.classList.remove('hidden');
        });

        voiceConfirmButton.addEventListener('click', function() {
            voiceConfirmationModal.classList.add('hidden');
            console.log("User confirmed voice input. Starting dictation...");
            try {
                recognition.start();
            } catch (e) {
                if (e.message.includes("recognition has already started")) {
                    showMessage("Voice recognition is already active.", "info");
                } else {
                    showMessage("Error starting voice recognition: " + e.message, "error");
                }
            }
        });

        voiceCancelButton.addEventListener('click', function() {
            console.log("User declined voice input.");
            showMessage("Voice input cancelled.", "info");
            voiceConfirmationModal.classList.add('hidden');
        });

        closeVoiceConfirmationModal.addEventListener('click', function() {
            voiceConfirmationModal.classList.add('hidden');
            console.log("Voice input cancelled via close button.");
            showMessage("Voice input cancelled.", "info");
        });

        voiceConfirmationModal.addEventListener('click', function(event) {
            if (event.target === voiceConfirmationModal) {
                voiceConfirmationModal.classList.add('hidden');
                console.log("Voice input cancelled by clicking outside.");
                showMessage("Voice input cancelled.", "info");
            }
        });

        allowNotificationsButton.addEventListener('click', function() {
            requestNotificationPermission();
        });

        dismissNotificationsButton.addEventListener('click', function() {
            localStorage.setItem(NOTIFICATION_PERMISSION_KEY, 'dismissed');
            notificationConsentModal.classList.add('hidden');
            showMessage("Notifications dismissed. You can re-enable them through browser settings if needed.", "info");
        });

        closeNotificationConsentModal.addEventListener('click', function() {
            localStorage.setItem(NOTIFICATION_PERMISSION_KEY, 'dismissed_temp'); 
            notificationConsentModal.classList.add('hidden');
            showMessage("Notification prompt closed.", "info");
        });

        notificationConsentModal.addEventListener('click', function(event) {
            if (event.target === notificationConsentModal) {
                localStorage.setItem(NOTIFICATION_PERMISSION_KEY, 'dismissed_temp'); 
                notificationConsentModal.classList.add('hidden');
                showMessage("Notification prompt closed.", "info");
            }
        });

        dismissUsbCounterBanner.addEventListener('click', function() {
            usbCounterBanner.classList.remove('show');
            usbCounterBanner.classList.add('hidden');
        });

        scanNowButton.addEventListener('click', async function() {
            usbScanModal.classList.remove('hidden');
            usbScanModalTitle.textContent = 'Counting USBs...';
            usbSpinner.classList.remove('hidden');
            usbScanMessage.textContent = 'Attempting to detect connected USB devices.';

            let usbCount = 0;
            let errorMessage = '';

            try {
                // Feature detection for WebUSB API
                if ('usb' in navigator) {
                    // This requests permission for ANY USB device.
                    // In a real scenario, you'd specify filters for known vendors/products.
                    // For demonstration, we'll try to get all allowed devices.
                    const devices = await navigator.usb.getDevices();
                    usbCount = devices.length;

                    if (usbCount > 0) {
                        usbScanMessage.textContent = `Found ${usbCount} USB device(s).`;
                    } else {
                        usbScanMessage.textContent = 'No USB devices found or permission not granted. Try connecting a device and allowing access.';
                    }
                } else {
                    errorMessage = 'WebUSB API not supported in this browser or environment.';
                }
            } catch (error) {
                console.error("USB scan error:", error);
                if (error.name === 'NotFoundError') {
                    errorMessage = 'No USB device selected or found. Please connect a device and try again.';
                } else if (error.name === 'SecurityError') {
                    errorMessage = 'USB access denied by browser or user. Please allow access if prompted.';
                } else {
                    errorMessage = `An error occurred during USB scan: ${error.message}`;
                }
            } finally {
                // Simulate a loading time before showing result
                setTimeout(() => {
                    usbSpinner.classList.add('hidden');
                    if (errorMessage) {
                        usbScanModalTitle.textContent = 'USB Scan Failed';
                        usbScanMessage.textContent = errorMessage;
                        usbScanModalContent.classList.remove('flex-col'); // Remove flex-col for better error message layout
                        usbScanModalContent.classList.add('text-red-600', 'font-semibold');
                    } else {
                        usbScanModalTitle.textContent = 'USB Scan Complete!';
                        usbScanModalContent.classList.remove('text-red-600', 'font-semibold');
                    }
                }, 2000); // 2 second delay for effect
            }
        });

        closeUsbScanModal.addEventListener('click', function() {
            usbScanModal.classList.add('hidden');
        });

        usbScanModal.addEventListener('click', function(event) {
            if (event.target === usbScanModal) {
                usbScanModal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
