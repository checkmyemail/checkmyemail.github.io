<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check if my email service is working</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- hCaptcha script -->
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 400px;
            position: relative;
        }
        /* Style for the question mark button inside the message box */
        #messageBox .question-mark-button {
            position: absolute;
            top: 0.75rem; /* Adjust as needed */
            right: 0.75rem; /* Adjust as needed */
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            color: inherit; /* Inherit color from parent message box */
            opacity: 0.7;
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            font-size: 1.25rem;
            font-weight: bold;
            line-height: 1;
        }
        #messageBox .question-mark-button:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        /* Alert styles */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        .alert-info {
            background-color: #DBEAFE; /* blue-100 */
            color: #1E40AF; /* blue-800 */
            border: 1px solid #93C5FD; /* blue-300 */
        }
        .alert-warning {
            background-color: #FFFBEB; /* yellow-100 */
            color: #92400E; /* yellow-800 */
            border: 1px solid #FCD34D; /* yellow-300 */
        }
        .alert-error {
            background-color: #FEE2E2; /* red-100 */
            color: #991B1B; /* red-800 */
            border: 1px solid #FCA5A5; /* red-300 */
        }
        .alert .close-button {
            background: none;
            border: none;
            color: inherit;
            font-size: 1.25rem;
            line-height: 1;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
        }
        .alert .close-button:hover {
            opacity: 1;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 pb-20">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md mb-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Test Your Email Reception</h1>

        <p class="text-gray-600 text-sm mb-6 text-center">
            Enter an email address below to verify that you are properly receiving emails.
        </p>

        <!-- Alert Message Container (New) -->
        <div id="alertMessageContainer" class="alert hidden">
            <span id="alertMessageText"></span>
            <button id="closeAlertMessage" class="close-button">
                &times;
            </button>
        </div>

        <form id="webhookForm" class="space-y-4">
            <div>
                <label for="emailInput" class="block text-gray-700 text-sm font-medium mb-2">Email to Test:</label>
                <div class="relative">
                    <input
                        type="email"
                        id="emailInput"
                        placeholder="your-email@example.com"
                        required
                        class="w-full pl-4 pr-12 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                    >
                    <button type="button" id="microphoneButton" class="absolute inset-y-0 right-0 flex items-center pr-3 focus:outline-none">
                        <!-- Microphone Icon (Inline SVG for simplicity) -->
                        <svg class="h-6 w-6 text-gray-500 hover:text-gray-700 transition-colors duration-200" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.2-3c0 3.53-2.93 6.43-6.4 6.43S4.4 14.53 4.4 11H3c0 3.98 3.44 7.27 7.8 7.74V22h2.4v-3.27c4.36-.47 7.8-3.76 7.8-7.74h-1.4z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <button
                type="submit"
                id="sendButton"
                class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200 shadow-md flex items-center justify-center"
            >
                <span id="buttonText">Send Test Email</span>
            </button>
        </form>

        <div id="messageBox" class="mt-6 p-4 rounded-lg hidden relative">
            <p id="messageText" class="font-medium"></p>
            <button id="messageErrorInfoButton" class="question-mark-button hidden">
                ðŸ¤”
            </button>
        </div>

        <div class="mt-6 pt-4 border-t border-gray-200 text-center">
            <button id="viewInfoButton" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 transition duration-200">
                Enable Developer Mode
            </button>
        </div>

    </div>

    <div id="businessEmailBanner" class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 flex flex-col sm:flex-row items-center justify-center sm:justify-between space-y-3 sm:space-y-0 sm:space-x-4 shadow-xl rounded-t-lg z-50 opacity-100 transition-opacity duration-500 ease-out">
        <p class="text-base font-semibold text-center sm:text-left">
            Uncover crucial website details and insights instantly, all without visiting it!
        </p>
        <div class="flex items-center space-x-3">
            <button id="getBusinessEmailButton" class="bg-white text-blue-700 px-5 py-2 rounded-full font-bold text-sm shadow-md hover:bg-gray-100 transition duration-200">
                Learn More
            </button>
            <button id="dismissBannerButton" class="text-white hover:text-gray-200 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <div id="limitInfoModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeLimitInfoModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Daily Email Limit Explained</h2>
            
            <div id="modalCountdownContainer" class="text-center mb-4 flex flex-col items-center justify-center">
                <p class="text-lg text-gray-700">Next test available in:</p>
                <div id="modalCountdownDisplay" class="text-5xl font-extrabold text-blue-600 mt-2">
                    --h --m --s
                </div>
            </div>

            <div class="mt-4 p-3 bg-gray-100 rounded-lg text-sm text-gray-700">
                <p>To ensure fair usage and manage resources, this service allows only one test email per user per day.</p>
                <p class="mt-2">This daily limit resets at <strong>0:00 UTC (Coordinated Universal Time)</strong>, which is midnight UTC. The countdown shown above indicates when you can send your next test email in your local time.</p>
                <p class="mt-2">This helps prevent abuse and keeps the service available for everyone.</p>
            </div>
        </div>
    </div>

    <!-- hCaptcha Modal -->
    <div id="hCaptchaModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeHCaptchaModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Verify You're Not a Robot</h2>
            <div id="hcaptchaWidgetContainer" class="flex justify-center my-6">
                <div class="h-captcha" data-sitekey="ee3c369e-9fb4-424c-8ad6-10c414fa6dac" data-callback="onHCaptchaSuccess" data-error-callback="onHCaptchaError"></div>
            </div>
            <div id="hCaptchaMessage" class="mt-4 p-3 rounded-lg hidden text-sm font-medium text-center"></div>
        </div>
    </div>

    <!-- Custom Voice Confirmation Modal -->
    <div id="voiceConfirmationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeVoiceConfirmationModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Voice Input Confirmation</h2>
            <p class="text-gray-700 text-base mb-4 text-center">
                Your voice will be sent to third-parties for dictation! Are you sure you want to continue?
            </p>
            <div class="flex justify-around mt-6 space-x-4">
                <button id="voiceConfirmButton" class="w-1/2 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-200">
                    Yes
                </button>
                <button id="voiceCancelButton" class="w-1/2 bg-gray-300 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-400 transition duration-200">
                    No
                </button>
            </div>
        </div>
    </div>

    <!-- Cookie Consent Modal -->
    <div id="cookieConsentModal" class="modal-overlay hidden">
        <div class="modal-content text-center p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Privacy Matters!</h2>
            <p class="text-gray-700 text-base mb-6">
                This website uses cookies to enhance your experience and provide essential functionality.
                We use cookies for:
            </p>
            <ul class="text-left text-gray-600 mb-6 space-y-2 list-disc list-inside">
                <li>Remembering your preferences (e.g., dismissing banners).</li>
                <li>Enabling features like unlimited email tests after hCaptcha verification.</li>
                <li>Ensuring the site functions correctly and efficiently.</li>
            </ul>
            <p class="text-gray-700 text-base mb-6">
                By clicking "Got It!", you consent to the use of these cookies.
                If you decline, some features may be unavailable.
            </p>
            <div class="flex justify-center space-x-4">
                <button id="acceptCookiesButton" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md">
                    Got It!
                </button>
                <button id="declineCookiesButton" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-200 shadow-md">
                    Decline
                </button>
            </div>
        </div>
    </div>

    <!-- Welcome Message Modal -->
    <div id="welcomeMessageModal" class="modal-overlay hidden">
        <div class="modal-content text-center p-6 bg-white rounded-xl shadow-lg">
            <button id="closeWelcomeMessageModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Welcome!</h2>
            <p id="welcomeMessageText" class="text-gray-700 text-base mb-6">
                You can test your email reception here.
            </p>
            <button id="welcomeModalDismissButton" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">
                Got It!
            </button>
        </div>
    </div>


    <script>
        const webhookForm = document.getElementById('webhookForm');
        const emailInput = document.getElementById('emailInput');
        const sendButton = document.getElementById('sendButton');
        const buttonText = document.getElementById('buttonText');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageErrorInfoButton = document.getElementById('messageErrorInfoButton');
        const microphoneButton = document.getElementById('microphoneButton');

        const viewInfoButton = document.getElementById('viewInfoButton');
        
        const businessEmailBanner = document.getElementById('businessEmailBanner');
        const getBusinessEmailButton = document.getElementById('getBusinessEmailButton');
        const dismissBannerButton = document.getElementById('dismissBannerButton');

        const limitInfoModal = document.getElementById('limitInfoModal');
        const closeLimitInfoModal = document.getElementById('closeLimitInfoModal');
        const modalCountdownContainer = document.getElementById('modalCountdownContainer');
        const modalCountdownDisplay = document.getElementById('modalCountdownDisplay');

        const hCaptchaModal = document.getElementById('hCaptchaModal');
        const closeHCaptchaModal = document.getElementById('closeHCaptchaModal');
        const hcaptchaWidgetContainer = document.getElementById('hcaptchaWidgetContainer');
        const hCaptchaMessage = document.getElementById('hCaptchaMessage');

        const voiceConfirmationModal = document.getElementById('voiceConfirmationModal');
        const closeVoiceConfirmationModal = document.getElementById('closeVoiceConfirmationModal');
        const voiceConfirmButton = document.getElementById('voiceConfirmButton');
        const voiceCancelButton = document.getElementById('voiceCancelButton');

        const cookieConsentModal = document.getElementById('cookieConsentModal');
        const acceptCookiesButton = document.getElementById('acceptCookiesButton');
        const declineCookiesButton = document.getElementById('declineCookiesButton');
        const COOKIE_CONSENT_KEY = 'cookieConsentAccepted'; 

        const welcomeMessageModal = document.getElementById('welcomeMessageModal'); 
        const welcomeModalDismissButton = document.getElementById('welcomeModalDismissButton');
        const welcomeMessageText = document.getElementById('welcomeMessageText');
        const closeWelcomeMessageModal = document.getElementById('closeWelcomeMessageModal'); // Changed ID

        // New Alert Elements
        const alertMessageContainer = document.getElementById('alertMessageContainer');
        const alertMessageText = document.getElementById('alertMessageText');
        const closeAlertMessage = document.getElementById('closeAlertMessage');


        const DEFAULT_WEBHOOK_URL = 'https://eo4grj5d1bhbj6f.m.pipedream.net';
        const LAST_SENT_KEY = 'lastEmailSentDateUTC';

        let countdownInterval;
        let isDeveloperModeChallengeActive = false;


        let recognition;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false; 
            recognition.interimResults = false; 
            recognition.lang = 'en-US'; 
        } else {
            console.warn('Web Speech API is not supported in this browser.');
            microphoneButton.disabled = true; 
            microphoneButton.title = 'Voice input not supported in this browser.';
        }

        recognition.onstart = function() {
            showMessage('Listening for your voice...', 'info');
            emailInput.placeholder = 'Speak now...';
        };

        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            emailInput.value = transcript.replace(/\s/g, ''); 
            showMessage(`Dictated: "${transcript}". Removed spaces for email format.`, 'success');
            emailInput.placeholder = 'your-email@example.com';
        };

        recognition.onend = function() {
            console.log('Speech recognition ended.');
            if (emailInput.value === '' || !emailInput.value.includes('@')) { 
                 showMessage('No valid email speech detected or recognition stopped. Please try again.', 'error');
            }
        };

        recognition.onerror = function(event) {
            let errorMessage = 'Speech recognition error: ' + event.error;
            if (event.error === 'no-speech') {
                errorMessage = 'No speech detected. Please try again.';
            } else if (event.error === 'not-allowed') {
                errorMessage = 'Microphone access denied. Please allow microphone in browser settings.';
            } else if (event.error === 'aborted') {
                errorMessage = 'Speech recognition aborted.';
            }
            showMessage(errorMessage, 'error');
            emailInput.placeholder = 'your-email@example.com';
        };

        window.onHCaptchaSuccess = function(token) {
            console.log('hCaptcha success! Token:', token);
            hCaptchaMessage.classList.add('hidden');
            hcaptchaWidgetContainer.classList.remove('hidden'); 

            if (isDeveloperModeChallengeActive) {
                isDeveloperModeChallengeActive = false;
                hCaptchaModal.classList.add('hidden');
                window.location.href = 'dev.html';
            } else {
                hCaptchaMessage.textContent = 'Verification successful!'; 
                hCaptchaMessage.classList.remove('hidden', 'bg-red-100', 'text-red-800');
                hCaptchaMessage.classList.add('bg-green-100', 'text-green-800');
                
                setTimeout(() => {
                    hCaptchaMessage.classList.add('hidden');
                }, 2000); 
            }
        };

        window.onHCaptchaError = function(error) {
            console.error('hCaptcha error:', error);
            isDeveloperModeChallengeActive = false; 
            hcaptchaWidgetContainer.classList.remove('hidden'); 

            hCaptchaMessage.textContent = 'Verification failed. Please try again.';
            hCaptchaMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800');
            hCaptchaMessage.classList.add('bg-red-100', 'text-red-800');
        };

        function hasSentEmailTodayUTC() {
            return false; // Always return false for unlimited tests
        }

        function updateLastSentDateUTC() {
            // Function no longer performs any action
        }

        function formatTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => String(num).padStart(2, '0');
            return `${pad(hours)}h ${pad(minutes)}m ${pad(seconds)}s`;
        }

        function startCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            const now = new Date();
            const nextDayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1, 0, 0, 0, 0));
            
            const options = { hour: 'numeric', minute: 'numeric', hour12: true, timeZoneName: 'short' };
            const localResetTime = nextDayUTC.toLocaleTimeString(undefined, options);

            const updateCountdown = () => {
                const remainingTime = nextDayUTC.getTime() - new Date().getTime();
                const formattedTime = formatTime(remainingTime);

                if (remainingTime <= 0) {
                    clearInterval(countdownInterval);
                    showMessage('You can now send another test email. Please try again!', 'info');
                    setButtonState(false);
                    messageErrorInfoButton.classList.add('hidden');
                    if (modalCountdownContainer) {
                        modalCountdownContainer.classList.add('hidden');
                    }
                    return;
                }

                messageText.innerHTML = `You can only send one test email per UTC day. The limit resets at <strong>${localResetTime}</strong>. Next test in: <span class="font-bold">${formattedTime}</span>`;
                messageErrorInfoButton.classList.remove('hidden');

                if (modalCountdownDisplay && !limitInfoModal.classList.contains('hidden')) {
                    modalCountdownDisplay.textContent = formattedTime;
                    modalCountdownContainer.classList.remove('hidden');
                }
            };

            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function handleHCaptchaInitiation() {
            const cookieConsent = localStorage.getItem(COOKIE_CONSENT_KEY);

            hCaptchaModal.classList.remove('hidden');
            hCaptchaMessage.classList.add('hidden'); 
            hcaptchaWidgetContainer.classList.remove('hidden'); 

            if (cookieConsent !== 'true') {
                hcaptchaWidgetContainer.classList.add('hidden'); 
                hCaptchaMessage.innerHTML = `
                    <p class="text-red-600 font-semibold mb-4">Cookies are required to use this feature.</p>
                    <p class="text-gray-700 text-sm mb-4">
                        Please accept cookies to proceed with verification.
                    </p>
                    <button id="showCookiePopupBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">
                        Show Cookie Popup
                    </button>
                `;
                hCaptchaMessage.classList.remove('hidden');
                
                document.getElementById('showCookiePopupBtn').onclick = function() {
                    hCaptchaModal.classList.add('hidden'); 
                    cookieConsentModal.classList.remove('hidden'); 
                };
            } else {
                hcaptcha.reset(); 
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);

            // Get parameters
            const prefillEmail = urlParams.get('prefillemail');
            const showWelcome = urlParams.get('showwelcome');
            const hideConsentParam = urlParams.get('hideconsent');
            const hideBanner = urlParams.get('hidebanner');
            const alertType = urlParams.get('alerttype'); // New parameter
            const alertString = urlParams.get('alertstring'); // New parameter

            // Log parameters to console
            console.log('URL Parameters:');
            console.log('  prefillemail:', prefillEmail);
            console.log('  showwelcome:', showWelcome);
            console.log('  hideconsent:', hideConsentParam);
            console.log('  hidebanner:', hideBanner);
            console.log('  alerttype:', alertType); // Log new parameter
            console.log('  alertstring:', alertString); // Log new parameter

            // Handle hideconsent parameter
            if (hideConsentParam === 'true') {
                localStorage.setItem(COOKIE_CONSENT_KEY, 'true');
                cookieConsentModal.classList.add('hidden');
            } else {
                const cookieConsent = localStorage.getItem(COOKIE_CONSENT_KEY);
                if (cookieConsent === null || cookieConsent === 'false') {
                    cookieConsentModal.classList.remove('hidden');
                }
            }

            // Handle prefillemail parameter
            if (prefillEmail) {
                emailInput.value = prefillEmail;
            }

            // Handle showwelcome parameter - now shows a modal
            if (showWelcome === 'true') {
                welcomeMessageModal.classList.remove('hidden');
            }

            // Existing hidebanner logic
            if (hideBanner === 'true') {
                businessEmailBanner.classList.add('hidden');
            }

            // Handle alert parameters (New Logic)
            if (alertType && alertString) {
                alertMessageText.textContent = alertString;
                alertMessageContainer.classList.remove('hidden');
                alertMessageContainer.classList.remove('alert-info', 'alert-warning', 'alert-error'); // Clear previous classes
                if (alertType === 'info') {
                    alertMessageContainer.classList.add('alert-info');
                } else if (alertType === 'warning') {
                    alertMessageContainer.classList.add('alert-warning');
                } else if (alertType === 'error') {
                    alertMessageContainer.classList.add('alert-error');
                } else {
                    // Default to info if invalid type
                    alertMessageContainer.classList.add('alert-info');
                }
            }
        });

        function showMessage(message, type = 'info') {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            messageText.innerHTML = message;
            messageBox.classList.remove('hidden', 'bg-green-100', 'border-green-200', 'text-green-800', 'bg-red-100', 'border-red-200', 'text-red-800', 'bg-blue-100', 'border-blue-200', 'text-blue-800');

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-200', 'text-green-800');
                messageErrorInfoButton.classList.add('hidden');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-200', 'text-red-800');
                if (message.includes('You can only send one test email per UTC day')) {
                     messageErrorInfoButton.classList.remove('hidden');
                } else {
                     messageErrorInfoButton.classList.add('hidden');
                }
            } else {
                messageBox.classList.add('bg-blue-100', 'border-blue-200', 'text-blue-800');
                messageErrorInfoButton.classList.add('hidden');
            }
            messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            messageErrorInfoButton.classList.add('hidden');
            if (modalCountdownContainer) {
                modalCountdownContainer.classList.add('hidden');
            }
        }

        function setButtonState(isLoading) {
            sendButton.disabled = isLoading;
            buttonText.textContent = isLoading ? 'Sending...' : 'Send Test Email';
        }

        webhookForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            hideMessage();
            setButtonState(true);

            const recipientEmail = emailInput.value;

            try {
                const response = await fetch(DEFAULT_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: recipientEmail
                    })
                });

                if (response.ok) {
                    showMessage(`Test email successfully sent to: <span class="font-bold">${recipientEmail}</span>. Please check your inbox.`, 'success');
                } else {
                    const errorText = await response.text();
                    showMessage(`Failed to send test email. Status: ${response.status}. ${errorText ? `Details: ${errorText}` : 'Please check your Pipedream account for logs and quota status.'}`, 'error');
                }
            } catch (error) {
                showMessage(`An error occurred: ${error.message}. Please check the URL and your network connection.`, 'error');
            } finally {
                setButtonState(false);
            }
        });

        viewInfoButton.addEventListener('click', function() {
            isDeveloperModeChallengeActive = true; 
            handleHCaptchaInitiation(); 
        });

        dismissBannerButton.addEventListener('click', function() {
            businessEmailBanner.classList.remove('opacity-100');
            businessEmailBanner.classList.add('opacity-0');
            setTimeout(() => {
                businessEmailBanner.classList.add('hidden');
            }, 500);
        });

        getBusinessEmailButton.addEventListener('click', function() {
            window.location.href = 'https://webinfofinder.github.io/';
        });

        messageErrorInfoButton.addEventListener('click', function() {
            limitInfoModal.classList.remove('hidden');
            startCountdown(); 
            if (modalCountdownContainer) {
                modalCountdownContainer.classList.add('hidden');
            }
        });

        closeLimitInfoModal.addEventListener('click', function() {
            limitInfoModal.classList.add('hidden');
            if (modalCountdownContainer) {
                modalCountdownContainer.classList.add('hidden');
            }
        });

        limitInfoModal.addEventListener('click', function(event) {
            if (event.target === limitInfoModal) {
                limitInfoModal.classList.add('hidden');
                if (modalCountdownContainer) {
                    modalCountdownContainer.classList.add('hidden');
                }
            }
        });

        closeHCaptchaModal.addEventListener('click', function() {
            hCaptchaModal.classList.add('hidden');
            hcaptcha.reset(); 
            hcaptchaWidgetContainer.classList.remove('hidden'); 
            hCaptchaMessage.classList.add('hidden'); 
            if (isDeveloperModeChallengeActive) { 
                isDeveloperModeChallengeActive = false;
            }
        });

        hCaptchaModal.addEventListener('click', function(event) {
            if (event.target === hCaptchaModal) {
                hCaptchaModal.classList.add('hidden');
                hcaptcha.reset();
                hcaptchaWidgetContainer.classList.remove('hidden'); 
                hCaptchaMessage.classList.add('hidden'); 
                if (isDeveloperModeChallengeActive) { 
                    isDeveloperModeChallengeActive = false;
                }
            }
        });

        microphoneButton.addEventListener('click', function() {
            if (!recognition) {
                showMessage("Voice input is not supported in this browser.", "error");
                return;
            }
            voiceConfirmationModal.classList.remove('hidden');
        });

        voiceConfirmButton.addEventListener('click', function() {
            voiceConfirmationModal.classList.add('hidden');
            console.log("User confirmed voice input. Starting dictation...");
            try {
                recognition.start();
            }
            catch (e) {
                if (e.message.includes("recognition has already started")) {
                    showMessage("Voice recognition is already active.", "info");
                } else {
                    showMessage("Error starting voice recognition: " + e.message, "error");
                }
            }
        });

        voiceCancelButton.addEventListener('click', function() {
            console.log("User declined voice input.");
            showMessage("Voice input cancelled.", "info");
            voiceConfirmationModal.classList.add('hidden');
        });

        closeVoiceConfirmationModal.addEventListener('click', function() {
            voiceConfirmationModal.classList.add('hidden');
            console.log("Voice input cancelled via close button.");
            showMessage("Voice input cancelled.", "info");
        });

        voiceConfirmationModal.addEventListener('click', function(event) {
            if (event.target === voiceConfirmationModal) {
                voiceConfirmationModal.classList.add('hidden');
                console.log("Voice input cancelled by clicking outside.");
                showMessage("Voice input cancelled.", "info");
            }
        });

        // Welcome Message Modal Listeners
        closeWelcomeMessageModal.addEventListener('click', () => { // Changed ID
            welcomeMessageModal.classList.add('hidden');
        });

        welcomeModalDismissButton.addEventListener('click', () => {
            welcomeMessageModal.classList.add('hidden');
        });

        welcomeMessageModal.addEventListener('click', (event) => {
            if (event.target === welcomeMessageModal) {
                welcomeMessageModal.classList.add('hidden');
            }
        });

        // Close Alert Message
        closeAlertMessage.addEventListener('click', () => {
            alertMessageContainer.classList.add('hidden');
        });

        // Cookie Consent Modal Listeners
        acceptCookiesButton.addEventListener('click', function() {
            localStorage.setItem(COOKIE_CONSENT_KEY, 'true');
            cookieConsentModal.classList.add('hidden');
            if (!hCaptchaModal.classList.contains('hidden')) {
                handleHCaptchaInitiation();
            }
        });

        declineCookiesButton.addEventListener('click', function() {
            localStorage.setItem(COOKIE_CONSENT_KEY, 'false');
            cookieConsentModal.classList.add('hidden');
            showMessage("You have declined cookies. Some features, like hCaptcha verification, may not be available.", "info");
            if (!hCaptchaModal.classList.contains('hidden')) {
                handleHCaptchaInitiation();
            }
        });

        cookieConsentModal.addEventListener('click', function(event) {
            if (event.target === cookieConsentModal) {
                localStorage.setItem(COOKIE_CONSENT_KEY, 'false');
                cookieConsentModal.classList.add('hidden');
                showMessage("You have declined cookies. Some features, like hCaptcha verification, may not be available.", "info");
                if (!hCaptchaModal.classList.contains('hidden')) {
                    handleHCaptchaInitiation();
                }
            }
        });
    </script>
</body>
</html>
